<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Выбор тренировки</title>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-firestore.js"></script>
</head>
      <!-- Подключаем Firebase SDK версии 8.9.1 -->
  <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-firestore.js"></script>
  
  <script>
    // Конфигурация Firebase (v8)
    var firebaseConfig = {
      apiKey: "AIzaSyCIXtcjkj6kLTqwStdD7RtMCuiycrKBH0k",
      authDomain: "fitnessapp-f519f.firebaseapp.com",
      projectId: "fitnessapp-f519f",
      storageBucket: "fitnessapp-f519f.appspot.com",
      messagingSenderId: "1000735476286",
      appId: "1:1000735476286:web:4a62a875917834dd215f6f",
      measurementId: "G-MJ8K8ZNQM4"
    };
    // Инициализация Firebase
    firebase.initializeApp(firebaseConfig);
    var auth = firebase.auth();
    var db = firebase.firestore();

    // Функция проверки состояния аутентификации
    function checkAuthState() {
      auth.onAuthStateChanged(function(user) {
        if (user) {
          document.getElementById("user-status").textContent = "Welcome, " + user.email;
          document.getElementById("login-link").style.display = "none";
          document.getElementById("logout-btn").style.display = "inline-block";
          // Если есть элемент для админ-панели, показываем его:
          var adminPanel = document.getElementById("admin-panel");
          if(adminPanel) { adminPanel.style.display = "block"; }
        } else {
          document.getElementById("user-status").textContent = "Please log in";
          document.getElementById("login-link").style.display = "inline-block";
          document.getElementById("logout-btn").style.display = "none";
          if(document.getElementById("admin-panel")){
            document.getElementById("admin-panel").style.display = "none";
          }
        }
      });
    }

    // Функция выхода из системы
    function logoutUser() {
      firebase.auth().signOut().then(function() {
        console.log("User signed out.");
      }).catch(function(error) {
        console.error("Error signing out: ", error);
      });
    }

    // Загрузка меню из файла menu.html и проверка авторизации
    document.addEventListener("DOMContentLoaded", function () {
    fetch('menu.html')
        .then(response => response.text())
        .then(html => {
            document.getElementById("navbar-container").innerHTML = html;
            checkAuthState();
            initBurgerMenu(); // Запуск функции инициализации бургера после вставки меню
        })
        .catch(err => {
            console.error("Ошибка загрузки меню:", err);
            document.getElementById("navbar-container").innerHTML = `
                <span id="user-status">Please log in</span>
                <a href="login.html" id="login-link">Login</a>
                <button onclick="logoutUser()" id="logout-btn" style="display:none;">Logout</button>`;
            checkAuthState();
        });
});

// Функция инициализации меню-бургера
function initBurgerMenu() {
    const menuToggle = document.querySelector(".menu-toggle");
    const navbarList = document.querySelector(".navbar-list")

    if (menuToggle && navbarList) {
        menuToggle.addEventListener("click", function () {
            navbarList.classList.toggle("active");
            menuToggle.classList.toggle("active");
        });
    }
}
  </script>
    <!-- Контейнер для меню (загружается динамически из menu.html) -->
  <div id="navbar-container"></div>
<body>
    <h1>Выбери тренировку на сегодня</h1>
    <p>Можешь создать тренировку на свой вкус. Например, выбрать только одну группу мышц или комбинацию из двух-трех.</p>
    
    <label for="workout1">Первая группа мышц:</label>
    <select id="workout1" class="workout-select">
        <option value="">Выберите группу мышц</option>
    </select>
    
    <label for="workout2">Вторая группа мышц:</label>
    <select id="workout2" class="workout-select">
        <option value="">Выберите группу мышц</option>
    </select>
    
    <label for="workout3">Третья группа мышц:</label>
    <select id="workout3" class="workout-select">
        <option value="">Выберите группу мышц</option>
    </select>
    
    <button id="generateWorkout">Сгенерировать тренировку</button>
    <div id="workoutResults"></div>
    

        
        <script>
        let allWorkouts = [];

        async function loadWorkouts() {
            try {
                const snapshot = await db.collection("workouts").get();
                allWorkouts = snapshot.docs.map(doc => doc.id);
                updateDropdowns();
            } catch (error) {
                console.error("Ошибка загрузки тренировок:", error);
            }
        }
        
        function updateDropdowns() {
            document.querySelectorAll(".workout-select").forEach(select => {
                let selectedValue = select.getAttribute("data-selected") || "";
                select.innerHTML = '<option value="">Выберите группу мышц</option>';
                let selectedWorkouts = getSelectedWorkouts();
                allWorkouts.forEach(workout => {
                    if (!selectedWorkouts.includes(workout) || workout === selectedValue) {
                        let option = document.createElement("option");
                        option.value = workout;
                        option.textContent = workout;
                        if (workout === selectedValue) option.selected = true;
                        select.appendChild(option);
                    }
                });
            });
        }

        function getSelectedWorkouts() {
            return Array.from(document.querySelectorAll(".workout-select"))
                .map(select => select.value)
                .filter(value => value);
        }
        
        document.querySelectorAll(".workout-select").forEach(select => {
            select.addEventListener("change", (event) => {
                event.target.setAttribute("data-selected", event.target.value);
                updateDropdowns();
            });
        });

        document.getElementById("generateWorkout").addEventListener("click", async () => {
            const selectedWorkouts = getSelectedWorkouts();
            if (selectedWorkouts.length === 0) {
                alert("Выберите хотя бы одну группу мышц!");
                return;
            }

            let workoutPlan = [];
            let muscleCount = {}; // Для отслеживания количества повторений упражнений для каждой мышечной группы
            for (const workout of selectedWorkouts) {
                const snapshot = await db.collection("workouts").doc(workout).collection("exercises").get();
                const exercises = snapshot.docs.map(doc => doc.data());
                
                let mainExercises = exercises.filter(e => e.exercisetype === "Основное");
                let isolationExercises = exercises.filter(e => e.exercisetype === "Изолирующее");
                
                shuffleArray(mainExercises);
                shuffleArray(isolationExercises);
                
                if (selectedWorkouts.length === 1) {
                    workoutPlan.push(...getFilteredExercises(mainExercises, 4, muscleCount), ...getFilteredExercises(isolationExercises, 4, muscleCount));
                } else if (selectedWorkouts.length === 2) {
                    workoutPlan.push(...getFilteredExercises(mainExercises, 2, muscleCount), ...getFilteredExercises(isolationExercises, 2, muscleCount));
                } else {
                    workoutPlan.push(...getFilteredExercises(mainExercises, 1, muscleCount), ...getFilteredExercises(isolationExercises, 2, muscleCount));
                }
            }
            
            displayWorkout(workoutPlan);
        });
        
        function shuffleArray(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        function displayWorkout(workoutPlan) {
            const container = document.getElementById("workoutResults");
            container.innerHTML = "";
            
            workoutPlan.forEach(exercise => {
                const embedUrl = exercise.video.replace("watch?v=", "embed/");
                const exerciseElement = document.createElement("div");
                exerciseElement.innerHTML = `
                    <h3>${exercise.exercisename}</h3>
                    <img src="${exercise.photo}" alt="${exercise.exercisename}" width="150">
                    <p>Тип: ${exercise.exercisetype}</p>
                    <p>Мышцы: ${exercise.muscle}</p>
                    <p>Доп. мышцы: ${exercise.muscletypeadditional}</p>
                    <p>Подходы: ${exercise.sets}</p>
                    <p>Повторы: ${exercise.reps}</p>
                    <button onclick="toggleDetails(this, '${embedUrl}', '${exercise.description}')">Подробнее</button>
                    <div class="exercise-details" style="display:none;">
                        <iframe width="300" height="200" src="${embedUrl}" frameborder="0" allowfullscreen></iframe>
                        <p>${exercise.description}</p>
                    </div>
                `;
                container.appendChild(exerciseElement);
            });
        }
        
        function toggleDetails(button, video, description) {
            const details = button.nextElementSibling;
            if (details.style.display === "none") {
                details.style.display = "block";
                button.textContent = "Скрыть";
            } else {
                details.style.display = "none";
                button.textContent = "Подробнее";
            }
        }

        // Функция для фильтрации упражнений с учетом количества повторений мышечных групп
        function getFilteredExercises(exercises, maxCount, muscleCount) {
            let filteredExercises = [];
            for (const exercise of exercises) {
                if (muscleCount[exercise.muscle]) {
                    // Проверяем, сколько раз упражнение с этим мышечным атрибутом было добавлено
                    if (muscleCount[exercise.muscle] >= 2) {
                        continue; // Пропускаем упражнения, если их добавлено больше двух раз
                    }
                }
                
                // Добавляем упражнение в план тренировки
                filteredExercises.push(exercise);
                muscleCount[exercise.muscle] = (muscleCount[exercise.muscle] || 0) + 1;
                
                if (filteredExercises.length >= maxCount) {
                    break;
                }
            }
            return filteredExercises;
        }

        loadWorkouts();
    </script>
</body>
</html>
