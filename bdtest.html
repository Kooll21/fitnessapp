<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проверка подключения к базе данных</title>
    <style>
        #navbar-container {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        body {
            margin-top: 60px; /* Чтобы контент не перекрывался меню */
        }

        #status {
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
        }

        #status.success {
            color: green;
        }

        #status.error {
            color: red;
        }

        .description {
            display: none;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="navbar-container"></div> <!-- Контейнер для меню -->

    <h1>Тестирование подключения к базе данных</h1>
    <button onclick="testFirestoreConnection()">Проверить подключение</button>
    <p id="status"></p>
    <p id="fileCount"></p>
    <ul id="documentList"></ul>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCIXtcjkj6kLTqwStdD7RtMCuiycrKBH0k",
            authDomain: "fitnessapp-f519f.firebaseapp.com",
            projectId: "fitnessapp-f519f",
            storageBucket: "fitnessapp-f519f.appspot.com",
            messagingSenderId: "1000735476286",
            appId: "1:1000735476286:web:4a62a875917834dd215f6f",
            measurementId: "G-MJ8K8ZNQM4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Загрузка меню
        async function loadMenu() {
            try {
                const response = await fetch('menu.html');
                if (!response.ok) {
                    throw new Error('Не удалось загрузить menu.html');
                }
                const html = await response.text();
                document.getElementById('navbar-container').innerHTML = html;
                checkAuthState(); // После загрузки меню проверяем статус аутентификации
            } catch (error) {
                console.error('Ошибка при загрузке меню:', error);
                alert('Ошибка загрузки меню. Проверьте консоль для подробностей.');
            }
        }

        // Проверка состояния аутентификации
        function checkAuthState() {
            const adminButton = document.getElementById("admin-panel");
            const userStatus = document.getElementById("user-status");
            const loginLink = document.getElementById("login-link");
            const logoutBtn = document.getElementById("logout-btn");

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Пользователь авторизован
                    userStatus.textContent = Welcome, ${user.email};
                    loginLink.style.display = 'none';
                    logoutBtn.style.display = 'block';
                    adminButton.style.display = 'block'; // Показываем кнопку Admin Panel
                    localStorage.setItem("user", JSON.stringify(user)); // Сохраняем данные о пользователе в localStorage
                } else {
                    // Пользователь не авторизован
                    userStatus.textContent = 'Please log in';
                    loginLink.style.display = 'inline-block';
                    logoutBtn.style.display = 'none';
                    adminButton.style.display = 'none'; // Скрываем кнопку Admin Panel
                    localStorage.removeItem("user"); // Удаляем данные о пользователе из localStorage
                }
            });
        }

        // Выход из системы
        window.logoutUser = function() {
            signOut(auth)
                .then(() => {
                    document.getElementById("user-status").textContent = 'Please log in';
                    document.getElementById("login-link").style.display = 'inline-block';
                    document.getElementById("logout-btn").style.display = 'none';
                    document.getElementById("admin-panel").style.display = 'none';
                    localStorage.removeItem("user"); // Убираем данные пользователя при выходе
                })
                .catch((error) => {
                    console.error('Ошибка при выходе:', error);
                });
        };

        // Восстановление данных о пользователе при загрузке страницы
        document.addEventListener("DOMContentLoaded", function() {
            loadMenu(); // Загружаем меню
            const userData = localStorage.getItem("user");
            if (userData) {
                const user = JSON.parse(userData);
                console.log("Восстановлен пользователь:", user);
                checkAuthState(); // Проверяем статус аутентификации при восстановлении
            }
        });
    </script>

</body>
</html>
