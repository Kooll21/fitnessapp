<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проверка подключения к базе данных</title>

    <!-- Подключаем Firebase SDK (8.9.1) -->
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js"></script>

    <style>
        #status {
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
        }
        #status.success {
            color: green;
        }
        #status.error {
            color: red;
        }
        /* Скрываем описание по умолчанию */
        .description {
            display: none;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Тестирование подключения к базе данных</h1>
    
    <button onclick="testFirestoreConnection()">Проверить подключение</button>
    <p id="status"></p> <!-- Для вывода статуса подключения -->
    <p id="fileCount"></p>
    <ul id="documentList"></ul><!-- Для вывода количества документов в коллекции -->

    <script>
        // Инициализация Firebase
        var firebaseConfig = {
            apiKey: "AIzaSyCIXtcjkj6kLTqwStdD7RtMCuiycrKBH0k",
            authDomain: "fitnessapp-f519f.firebaseapp.com",
            projectId: "fitnessapp-f519f",
            storageBucket: "fitnessapp-f519f.appspot.com",
            messagingSenderId: "1000735476286",
            appId: "1:1000735476286:web:4a62a875917834dd215f6f",
            measurementId: "G-MJ8K8ZNQM4"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();
        
        // Функция для поиска подколлекций вручную (обходное решение для SDK 8)
        function getSubcollectionsCount(docId, subcollectionList) {
            var possibleSubcollections = ["exercises", "history", "stats"]; // <-- Укажи реальные имена подколлекций
            var foundSubcollections = [];

            possibleSubcollections.forEach(subcollection => {
                db.collection("workouts").doc(docId).collection(subcollection).get()
                    .then(snapshot => {
                        if (!snapshot.empty) {
                            foundSubcollections.push(subcollection);
                            var subListItem = document.createElement("li");
                            subListItem.textContent = subcollection;
                            subcollectionList.appendChild(subListItem);

                            var docCountItem = document.createElement("span");
                            docCountItem.textContent = ` (${snapshot.size} упражнений)`;
                            subListItem.appendChild(docCountItem);

                            loadDocumentsInSubcollection(docId, subcollection, subListItem);
                        }
                    })
                    .catch(error => {
                        console.error("Ошибка при загрузке подколлекции:", error);
                    });
            });

            setTimeout(() => {
                if (foundSubcollections.length === 0) {
                    var noSubcollectionsItem = document.createElement("li");
                    noSubcollectionsItem.textContent = "Нет подколлекций";
                    subcollectionList.appendChild(noSubcollectionsItem);
                }
            }, 1000);
        }

        // Функция для загрузки документов в подколлекции
        function loadDocumentsInSubcollection(docId, subcollection, subListItem) {
            db.collection("workouts").doc(docId).collection(subcollection).get()
                .then(snapshot => {
                    if (!snapshot.empty) {
                        var subDocsList = document.createElement("ul"); // Вложенный список для документов подколлекции
                        subListItem.appendChild(subDocsList);

                        snapshot.forEach(doc => {
                            var docItem = document.createElement("li");
                            docItem.textContent = "Упражнение: " + doc.id;
                            subDocsList.appendChild(docItem);

                            // Отображаем атрибуты из документа подколлекции (muscles, reps, sets, type)
                            var muscles = doc.data().muscles || "Не указано";
                            var reps = doc.data().reps || "Не указано";
                            var sets = doc.data().sets || "Не указано";
                            var type = doc.data().type || "Не указано";
                            var description = doc.data().description || "Не указано";

                            var attributes = document.createElement("ul");

                            var musclesItem = document.createElement("li");
                            musclesItem.textContent = "Мышцы: " + muscles;
                            attributes.appendChild(musclesItem);

                            var repsItem = document.createElement("li");
                            repsItem.textContent = "Повторения: " + reps;
                            attributes.appendChild(repsItem);

                            var setsItem = document.createElement("li");
                            setsItem.textContent = "Сеты: " + sets;
                            attributes.appendChild(setsItem);

                            var typeItem = document.createElement("li");
                            typeItem.textContent = "Тип: " + type;
                            attributes.appendChild(typeItem);
                            
                            var descriptionItem = document.createElement("li");
                            descriptionItem.textContent = "Описание: ";
                            var descriptionDiv = document.createElement("div");
                            descriptionDiv.classList.add("description");
                            descriptionDiv.textContent = description;
                            descriptionItem.appendChild(descriptionDiv);

                            // Кнопка "Подробности"
                            var toggleButton = document.createElement("button");
                            toggleButton.textContent = "Подробнее";
                            toggleButton.onclick = function() {
                                var desc = descriptionItem.querySelector(".description");
                                var isVisible = desc.style.display === "block";
                                desc.style.display = isVisible ? "none" : "block";
                                toggleButton.textContent = isVisible ? "Подробнее" : "Скрыть";
                            };
                            descriptionItem.appendChild(toggleButton);

                            attributes.appendChild(descriptionItem);

                            // Добавляем список атрибутов к упражнению
                            docItem.appendChild(attributes);
                        });
                    } else {
                        var noDocsItem = document.createElement("li");
                        noDocsItem.textContent = "Нет документов в подколлекции";
                        subListItem.appendChild(noDocsItem);
                    }
                })
                .catch(error => {
                    console.error("Ошибка при загрузке документов подколлекции:", error);
                });
        }

        // Функция для тестирования подключения
        document.addEventListener('DOMContentLoaded', function() {
            window.testFirestoreConnection = function() {
                var statusElement = document.getElementById('status');
                var fileCountElement = document.getElementById('fileCount');
                var documentListElement = document.getElementById('documentList');
                documentListElement.innerHTML = ""; // Очищаем список перед загрузкой новых данных

                console.log('testFirestoreConnection вызвана');

                db.collection("workouts").get()
                    .then(function(querySnapshot) {
                        if (querySnapshot.empty) {
                            statusElement.textContent = "Ошибка: Коллекция пуста. Добавьте хотя бы один документ.";
                            statusElement.classList.remove('success');
                            statusElement.classList.add('error');
                            fileCountElement.textContent = "";
                        } else {
                            statusElement.textContent = "Подключение успешно!";
                            statusElement.classList.remove('error');
                            statusElement.classList.add('success');
                            fileCountElement.textContent = "Количество тренировок: " + querySnapshot.size;

                            querySnapshot.forEach(function(doc) {
                                console.log("Тренировка:", doc.id, doc.data());

                                // Создаем элемент списка
                                var listItem = document.createElement("li");
                                listItem.textContent = "Тренировка: " + doc.id;

                                // Создаем вложенный список для подколлекций
                                var subcollectionList = document.createElement("ul");
                                listItem.appendChild(subcollectionList);

                                documentListElement.appendChild(listItem);

                                // Загружаем подколлекции
                                getSubcollectionsCount(doc.id, subcollectionList);
                            });
                        }
                    })
                    .catch(function(error) {
                        statusElement.textContent = "Ошибка подключения к Firestore: " + error.message;
                        statusElement.classList.remove('success');
                        statusElement.classList.add('error');
                        fileCountElement.textContent = "";
                    });
            };
        });

    </script>
</body>
</html>
