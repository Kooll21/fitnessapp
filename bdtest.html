<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Page</title>
  

  <!-- Подключаем Firebase SDK версии 8.9.1 -->
  <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-firestore.js"></script>
  
  <script>
    // Конфигурация Firebase (v8)
    var firebaseConfig = {
      apiKey: "AIzaSyCIXtcjkj6kLTqwStdD7RtMCuiycrKBH0k",
      authDomain: "fitnessapp-f519f.firebaseapp.com",
      projectId: "fitnessapp-f519f",
      storageBucket: "fitnessapp-f519f.appspot.com",
      messagingSenderId: "1000735476286",
      appId: "1:1000735476286:web:4a62a875917834dd215f6f",
      measurementId: "G-MJ8K8ZNQM4"
    };
    // Инициализация Firebase
    firebase.initializeApp(firebaseConfig);
    var auth = firebase.auth();
    var db = firebase.firestore();

    // Функция проверки состояния аутентификации
    function checkAuthState() {
      auth.onAuthStateChanged(function(user) {
        if (user) {
          document.getElementById("user-status").textContent = "Welcome, " + user.email;
          document.getElementById("login-link").style.display = "none";
          document.getElementById("logout-btn").style.display = "inline-block";
          // Если есть элемент для админ-панели, показываем его:
          var adminPanel = document.getElementById("admin-panel");
          if(adminPanel) { adminPanel.style.display = "block"; }
        } else {
          document.getElementById("user-status").textContent = "Please log in";
          document.getElementById("login-link").style.display = "inline-block";
          document.getElementById("logout-btn").style.display = "none";
          if(document.getElementById("admin-panel")){
            document.getElementById("admin-panel").style.display = "none";
          }
        }
      });
    }

    // Функция выхода из системы
    function logoutUser() {
      firebase.auth().signOut().then(function() {
        console.log("User signed out.");
      }).catch(function(error) {
        console.error("Error signing out: ", error);
      });
    }

    // Загрузка меню из файла menu.html и проверка авторизации
    document.addEventListener("DOMContentLoaded", function () {
    fetch('menu.html')
        .then(response => response.text())
        .then(html => {
            document.getElementById("navbar-container").innerHTML = html;
            checkAuthState();
            initBurgerMenu(); // Запуск функции инициализации бургера после вставки меню
        })
        .catch(err => {
            console.error("Ошибка загрузки меню:", err);
            document.getElementById("navbar-container").innerHTML = `
                <span id="user-status">Please log in</span>
                <a href="login.html" id="login-link">Login</a>
                <button onclick="logoutUser()" id="logout-btn" style="display:none;">Logout</button>`;
            checkAuthState();
        });
});

// Функция инициализации меню-бургера
function initBurgerMenu() {
    const menuToggle = document.querySelector(".menu-toggle");
    const navbarList = document.querySelector(".navbar-list")

    if (menuToggle && navbarList) {
        menuToggle.addEventListener("click", function () {
            navbarList.classList.toggle("active");
            menuToggle.classList.toggle("active");
        });
    }
}
  </script>
</head>
<body>
  <!-- Контейнер для меню (загружается динамически из menu.html) -->
  <div id="navbar-container"></div>
  
  <!-- Основной контент страницы -->
  
  <!-- Раздел для тестирования подключения к базе данных -->
  <h1>Тестирование подключения к базе данных</h1>
  <button onclick="testFirestoreConnection()">Проверить подключение</button>
  <p id="status"></p>
  <p id="fileCount"></p>
  <ul id="documentList"></ul>
  
  <script>
    // Функция для поиска подколлекций (для каждого документа коллекции "workouts")
    function getSubcollectionsCount(docId, subcollectionList) {
      var possibleSubcollections = ["exercises", "history", "stats"];
      var foundSubcollections = [];
      
      possibleSubcollections.forEach(function(subcollection) {
        db.collection("workouts").doc(docId).collection(subcollection).get()
          .then(function(snapshot) {
            if (!snapshot.empty) {
              foundSubcollections.push(subcollection);
              var subListItem = document.createElement("li");
              subListItem.textContent = subcollection;
              subcollectionList.appendChild(subListItem);
              
              var docCountItem = document.createElement("span");
              docCountItem.textContent = " (" + snapshot.size + " упражнений)";
              subListItem.appendChild(docCountItem);
              
              loadDocumentsInSubcollection(docId, subcollection, subListItem);
            }
          })
          .catch(function(error) {
            console.error("Ошибка при загрузке подколлекции:", error);
          });
      });
      
      setTimeout(function() {
        if (foundSubcollections.length === 0) {
          var noSubcollectionsItem = document.createElement("li");
          noSubcollectionsItem.textContent = "Нет подколлекций";
          subcollectionList.appendChild(noSubcollectionsItem);
        }
      }, 1000);
    }
    
// Функция для загрузки документов в подколлекции
function loadDocumentsInSubcollection(docId, subcollection, subListItem) {
  console.log("Функция loadDocumentsInSubcollection вызвана для документа:", docId);

  db.collection("workouts").doc(docId).collection(subcollection).get()
    .then(function(snapshot) {
      if (!snapshot.empty) {
        var subDocsList = document.createElement("ul");
        subListItem.appendChild(subDocsList);
        snapshot.forEach(function(doc) {
          console.log("Документ получен:", doc.id, doc.data()); // Лог всех данных документа

          var docItem = document.createElement("li");
          docItem.textContent = "Упражнение: " + doc.id;
          subDocsList.appendChild(docItem);

          // Выводим атрибуты упражнения
          var muscles = doc.data().muscle || "Не указано";
          var reps = doc.data().reps || "Не указано";
          var sets = doc.data().sets || "Не указано";
          var type = doc.data().exercisetype || "Не указано";
          var description = doc.data().description || "Не указано";
          var videoUrl = doc.data().video || "";  // Ссылка на видео
          
          console.log("Исходное описание из Firestore:", description);

          // Если данные введены вручную через Firestore и содержат экранированные "\n", заменяем их на реальные переводы строки
          description = description.replace(/\\n/g, "\n");

          console.log("Обработанное описание после замены \\n:", description);

          var attributes = document.createElement("ul");
          
          var musclesItem = document.createElement("li");
          musclesItem.textContent = "Мышцы: " + muscles;
          attributes.appendChild(musclesItem);
          
          var repsItem = document.createElement("li");
          repsItem.textContent = "Повторения: " + reps;
          attributes.appendChild(repsItem);
          
          var setsItem = document.createElement("li");
          setsItem.textContent = "Сеты: " + sets;
          attributes.appendChild(setsItem);
          
          var typeItem = document.createElement("li");
          typeItem.textContent = "Тип: " + type;
          attributes.appendChild(typeItem);
          
          var descriptionItem = document.createElement("li");
          descriptionItem.textContent = "Описание: ";
          var descriptionDiv = document.createElement("div");
          
          descriptionDiv.classList.add("description");
          descriptionDiv.style.display = "none"; // Скрываем описание по умолчанию
          descriptionDiv.innerHTML = description.replace(/\n/g, "<br>");
          
          console.log("HTML-код для описания:", descriptionDiv.innerHTML);

          descriptionItem.appendChild(descriptionDiv);
          
          // Кнопка "Подробности"
          var toggleButton = document.createElement("button");
          toggleButton.textContent = "Подробнее";
          toggleButton.onclick = function() {
            var isVisible = descriptionDiv.style.display === "block";
            descriptionDiv.style.display = isVisible ? "none" : "block";
            toggleButton.textContent = isVisible ? "Подробнее" : "Скрыть";
          };
          descriptionItem.appendChild(toggleButton);
          attributes.appendChild(descriptionItem);

          // Видео
          if (videoUrl) {
            var videoItem = document.createElement("li");
            var iframe = document.createElement("iframe");
            iframe.width = "300";
            iframe.height = "170";

            // Преобразуем ссылку в формат "embed"
            var videoIdMatch = videoUrl.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/|.+\?v=))([^&]+)/);
            var videoId = videoIdMatch ? videoIdMatch[1] : null;

            if (videoId) {
              iframe.src = https://www.youtube.com/embed/${videoId};
              iframe.allowFullscreen = true;
              videoItem.appendChild(iframe);

              // Контейнер для видео, который будет скрыт по умолчанию
              var videoContainer = document.createElement("div");
              videoContainer.classList.add("video-container");
              videoContainer.style.display = "none"; // Скрыто по умолчанию
              videoContainer.appendChild(videoItem);
              attributes.appendChild(videoContainer);

              // Кнопка "Подробности" для видео
              var videoToggleButton = document.createElement("button");
              videoToggleButton.textContent = "Подробнее";
              videoToggleButton.onclick = function() {
                var isVisible = videoContainer.style.display === "block";
                videoContainer.style.display = isVisible ? "none" : "block";
                videoToggleButton.textContent = isVisible ? "Подробнее" : "Скрыть";
              };
              attributes.appendChild(videoToggleButton);
            } else {
              console.error("Некорректная ссылка на видео:", videoUrl);
            }
          }

          docItem.appendChild(attributes);
        });
      } else {
        var noDocsItem = document.createElement("li");
        noDocsItem.textContent = "Нет документов в подколлекции";
        subListItem.appendChild(noDocsItem);
      }
    })
    .catch(function(error) {
      console.error("Ошибка при загрузке документов подколлекции:", error);
    });
}
    
    // Функция для тестирования подключения к базе данных и загрузки тренировок
    function testFirestoreConnection() {
      var statusElement = document.getElementById("status");
      var fileCountElement = document.getElementById("fileCount");
      var documentListElement = document.getElementById("documentList");
      documentListElement.innerHTML = ""; // Очистка списка
      console.log("testFirestoreConnection вызвана");
      
      db.collection("workouts").get()
        .then(function(querySnapshot) {
          if (querySnapshot.empty) {
            statusElement.textContent = "Ошибка: Коллекция пуста. Добавьте хотя бы один документ.";
            statusElement.classList.remove("success");
            statusElement.classList.add("error");
            fileCountElement.textContent = "";
          } else {
            statusElement.textContent = "Подключение успешно!";
            statusElement.classList.remove("error");
            statusElement.classList.add("success");
            fileCountElement.textContent = "Количество тренировок: " + querySnapshot.size;
            
            querySnapshot.forEach(function(doc) {
              console.log("Тренировка:", doc.id, doc.data());
              var listItem = document.createElement("li");
              listItem.textContent = "Тренировка: " + doc.id;
              
              var subcollectionList = document.createElement("ul");
              listItem.appendChild(subcollectionList);
              
              documentListElement.appendChild(listItem);
              getSubcollectionsCount(doc.id, subcollectionList);
            });
          }
        })
        .catch(function(error) {
          statusElement.textContent = "Ошибка подключения к Firestore: " + error.message;
          statusElement.classList.remove("success");
          statusElement.classList.add("error");
          fileCountElement.textContent = "";
        });
    }
    
    // Делаем функцию testFirestoreConnection доступной глобально для onclick
    window.testFirestoreConnection = testFirestoreConnection;
  </script>
</body>
</html>
